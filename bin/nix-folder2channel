#!/usr/bin/env bash

if ! [ -f default.nix ]; then
    echo Please run at root of nixpkgs
    exit 1
fi

HASH=`nix-build nixos/release.nix -A channel --arg nixpkgs  '{ outPath = ./. ; revCount = "'$(git rev-list HEAD | wc -l)'"; shortRev = "'$(git rev-parse --short HEAD)'"; }' | awk -F'/' '{print $4}'`
TARBAL_NAME=`echo $HASH | sed -e 's/.*-//'`

nix-channel --remove nixos
nix-channel --add file:///nix/store/${HASH}/tarballs/nixos-${TARBAL_NAME}.tar.xz nixos
nix-channel --update
